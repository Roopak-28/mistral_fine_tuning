name: Convert CSV to Mistral JSONL
description: Converts a QnA CSV (with columns "question" and "answer" or "answers") to a JSONL-style list, returned as a JSON string, for Mistral instruction fine-tuning.

inputs:
  - { name: csvpth, type: Path }
  - { name: question_column, type: String }
  - { name: answer_column, type: String }

outputs:
  - { name: mistral_jsonl, type: String }

implementation:
  container:
    image: python:3.10
    command:
      - python3
      - -u
      - -c
      - |
        import argparse
        import pandas as pd
        import json
        import sys

        parser = argparse.ArgumentParser()
        parser.add_argument("--csvpth", type=str, required=True)
        parser.add_argument("--question_column", type=str, required=True)
        parser.add_argument("--answer_column", type=str, required=True)
        args = parser.parse_args()

        df = pd.read_csv(args.csvpth)
        if args.question_column not in df.columns:
            raise ValueError(f"Question column '{args.question_column}' not found in CSV!")
        if args.answer_column not in df.columns:
            raise ValueError(f"Answer column '{args.answer_column}' not found in CSV!")

        def get_answer(row):
            val = row[args.answer_column]
            if isinstance(val, str):
                if val.startswith("[") and val.endswith("]"):
                    try:
                        aslist = json.loads(val)
                        return aslist[0] if aslist else ""
                    except:
                        return val
                else:
                    return val
            elif isinstance(val, list):
                return val[0] if val else ""
            else:
                return str(val)

        output = []
        for _, row in df.iterrows():
            q = str(row[args.question_column])
            a = get_answer(row)
            output.append({ "text": f"<s>[INST] {q} [/INST] {a}</s>" })

        # Emit the result as a single JSON string to stdout
        print(json.dumps(output, ensure_ascii=False))
    args:
      - --csvpth
      - { inputPath: csvpth }
      - --question_column
      - { inputValue: question_column }
      - --answer_column
      - { inputValue: answer_column }
      - { outputValue: mistral_jsonl }
